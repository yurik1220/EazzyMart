<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout â€” Eazzy Mart</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Custom CSS - Load after Bootstrap to override -->
  <link rel="stylesheet" href="../css/webstyle.css">
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* Hide reCAPTCHA container since we're using invisible reCAPTCHA */
    #recaptcha-container {
      display: none;
    }
  </style>
</head>
<body>
  <!-- Header (Shopee Style) -->
  <header>
    <div class="header-container">
      <a href="Index.html" class="logo">
        <img src="../assets/images/eazzymartlogo.png" alt="Eazzy Mart Logo">
        <span>Eazzy Mart</span>
      </a>
      
      <div class="search-container">
        <form class="search-form">
          <input type="search" class="search-input" placeholder="Search for products..." aria-label="Search">
          <button type="submit" class="search-btn">
            <i class="fas fa-search"></i>
          </button>
        </form>
      </div>

      <div class="header-actions">
        <a href="Cart.html" class="cart-btn">
          <i class="fas fa-shopping-cart"></i>
          <span>Cart</span>
        </a>
        <a href="OrderTracking.html" class="checkout-btn" style="text-decoration: none;">
          <i class="fas fa-box-open"></i>
          <span>Orders</span>
        </a>
        <button type="button" class="logout-btn" id="logout-btn">
          <i class="fas fa-sign-out-alt"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Checkout Section (Shopee Style) -->
  <section id="checkout-section">
    <div class="checkout-header">
      <h2>Checkout</h2>
    </div>
    <form id="checkout-form">
      <div class="form-group">
        <label for="orderType" class="form-label">Order Type</label>
        <select id="orderType" name="orderType" class="form-select" required>
          <option value="" disabled selected>Select Order Type</option>
          <option value="Delivery">Delivery</option>
          <option value="Pickup">Pickup</option>
        </select>
      </div>

      <div class="form-group">
        <label for="name" class="form-label">Full Name</label>
        <input type="text" class="form-control" id="name" name="name" placeholder="Enter your full name" required>
      </div>

      <div class="form-group" id="address-group">
        <label for="address" class="form-label">Delivery Address</label>
        <input type="text" class="form-control" id="address" name="address" placeholder="Enter delivery address" required>
      </div>

      <div class="form-group" id="contact-group">
        <label for="contactnumber" class="form-label">Contact Number</label>
        <div class="input-group">
          <input type="tel" class="form-control" id="contactnumber" name="contactnumber" placeholder="Enter contact number (e.g., +639123456789)" required>
          <button type="button" class="btn btn-outline-primary" id="send-otp-btn" style="white-space: nowrap;">
            <i class="fas fa-sms"></i> Send OTP
          </button>
        </div>
        <div id="otp-verification-group" style="display: none; margin-top: 15px;">
          <label for="otp-code" class="form-label">Enter OTP Code</label>
          <div class="input-group">
            <input type="text" class="form-control" id="otp-code" placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}">
            <button type="button" class="btn btn-outline-success" id="verify-otp-btn">
              <i class="fas fa-check"></i> Verify
            </button>
          </div>
          <small class="form-text text-muted" id="otp-status"></small>
        </div>
        <div id="recaptcha-container"></div>
      </div>

      <div class="form-group">
        <label for="payment" class="form-label">Payment Method</label>
        <select id="payment" name="payment" class="form-select" required>
          <option value="" disabled selected>Select Payment Method</option>
          <option value="Cash On Delivery">Cash On Delivery</option>
          <option value="GCash">GCash</option>
          <option value="Pay at the store" id="pay-at-store-option">Pay at the store</option>
        </select>
      </div>

      <!-- Order Summary -->
      <div class="card mt-4" style="background: #f8f9fa; border: 1px solid #dee2e6;">
        <div class="card-body">
          <h5 class="card-title mb-3">Order Summary</h5>
          <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
            <span>Subtotal:</span>
            <strong id="checkout-subtotal">â‚±0.00</strong>
          </div>
          <div id="delivery-fee-row" style="display: none; justify-content: space-between; margin-bottom: 10px; color: #666;">
            <span>Delivery Fee:</span>
            <strong id="checkout-delivery-fee">â‚±50.00</strong>
          </div>
          <div id="free-delivery-row" style="display: none; margin-bottom: 10px; color: #28a745;">
            <small>âœ“ Free Delivery (order â‰¥ â‚±300)</small>
          </div>
          <div id="min-order-notice" style="display: none; margin-bottom: 10px; padding: 8px; background: #fff3cd; border-radius: 4px; font-size: 0.9em;">
            <small>ðŸ“¦ Add â‚±<span id="amount-needed">0</span> more for free delivery!</small>
          </div>
          <hr>
          <div style="display: flex; justify-content: space-between; font-size: 1.2em;">
            <strong>Total:</strong>
            <strong style="color: #ff6b35;" id="checkout-total">â‚±0.00</strong>
          </div>
        </div>
      </div>

      <button type="submit" class="btn-success mt-3">
        <i class="fas fa-check"></i> Complete Order
      </button>
    </form>

    <div style="margin-top: 20px;">
      <a href="Cart.html" class="btn btn-secondary" style="width: 100%; text-decoration: none; display: inline-flex; align-items: center; justify-content: center; gap: 8px;">
        <i class="fas fa-arrow-left"></i> Back to Cart
      </a>
    </div>
  </section>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Eazzy Mart. All rights reserved.</p>
  </footer>

  <!-- Firebase SDK -->
  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-analytics.js";
    import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/10.13.2/firebase-auth.js";

    // Your web app's Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyBpyryA-xavoaDe7iZkdzQqsQ0yW4C-qsQ",
      authDomain: "eazzymart-otp.firebaseapp.com",
      projectId: "eazzymart-otp",
      storageBucket: "eazzymart-otp.firebasestorage.app",
      messagingSenderId: "955094397680",
      appId: "1:955094397680:web:f9b84c0a1fa9939f0c8835",
      measurementId: "G-QWZHWQ093G"
    };

    try {
      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const analytics = getAnalytics(app);
      const auth = getAuth(app);

      // Make Firebase available globally for OTP functions
      window.firebaseAuth = auth;
      window.RecaptchaVerifier = RecaptchaVerifier;
      window.signInWithPhoneNumber = signInWithPhoneNumber;
      window.firebaseInitialized = true;
      
      console.log('Firebase initialized successfully');
    } catch (error) {
      console.error('Firebase initialization error:', error);
      window.firebaseInitialized = false;
      window.firebaseError = error.message;
    }
  </script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <!-- API Configuration - Must be loaded before other scripts -->
  <script src="../js/config.js"></script>
  <script src="../js/Index.js"></script>

  <script>
    // ============================================
    // ORDER SUMMARY CALCULATION
    // ============================================
    function updateOrderSummary() {
      const orderType = document.getElementById('orderType')?.value;
      const cart = JSON.parse(localStorage.getItem('cart')) || {};
      const cartItems = Object.values(cart);
      
      // Calculate subtotal
      const subtotal = cartItems.reduce((sum, item) => {
        return sum + (Number(item.price) || 0) * (Number(item.qty) || 0);
      }, 0);
      
      // Get configuration
      const minOrderAmount = window.MIN_ORDER_FOR_FREE_DELIVERY || 300;
      const deliveryFeeAmount = window.DELIVERY_FEE || 50;
      
      // Calculate delivery fee
      let deliveryFee = 0;
      let showDeliveryFee = false;
      let showFreeDelivery = false;
      let showMinOrderNotice = false;
      let amountNeeded = 0;
      
      if (orderType === 'Delivery') {
        if (subtotal < minOrderAmount) {
          deliveryFee = deliveryFeeAmount;
          showDeliveryFee = true;
          amountNeeded = minOrderAmount - subtotal;
          showMinOrderNotice = true;
        } else {
          showFreeDelivery = true;
        }
      }
      
      const total = subtotal + deliveryFee;
      
      // Update UI
      document.getElementById('checkout-subtotal').textContent = `â‚±${subtotal.toFixed(2)}`;
      document.getElementById('checkout-delivery-fee').textContent = `â‚±${deliveryFee.toFixed(2)}`;
      document.getElementById('checkout-total').textContent = `â‚±${total.toFixed(2)}`;
      document.getElementById('amount-needed').textContent = amountNeeded.toFixed(0);
      
      // Show/hide elements
      document.getElementById('delivery-fee-row').style.display = showDeliveryFee ? 'flex' : 'none';
      document.getElementById('free-delivery-row').style.display = showFreeDelivery ? 'block' : 'none';
      document.getElementById('min-order-notice').style.display = showMinOrderNotice ? 'block' : 'none';
    }
    
    // Update order summary on page load
    document.addEventListener('DOMContentLoaded', () => {
      updateOrderSummary();
    });

    // Order type change handler
    const orderTypeSelect = document.getElementById('orderType');
    const addressGroup = document.getElementById('address-group');
    const addressInput = document.getElementById('address');
    const paymentSelect = document.getElementById('payment');
    
    // Store Cash On Delivery option template for later restoration
    let cashOnDeliveryOptionTemplate = null;
    if (paymentSelect) {
      const existingOption = paymentSelect.querySelector('option[value="Cash On Delivery"]');
      if (existingOption) {
        cashOnDeliveryOptionTemplate = existingOption.cloneNode(true);
      }
    }
    
    // Store Pay at the store option template for later restoration
    let payAtStoreOptionTemplate = null;
    if (paymentSelect) {
      const existingPayAtStoreOption = paymentSelect.querySelector('option[value="Pay at the store"]');
      if (existingPayAtStoreOption) {
        payAtStoreOptionTemplate = existingPayAtStoreOption.cloneNode(true);
        // Initially remove it (hidden by default for Delivery)
        existingPayAtStoreOption.remove();
      }
    }

    function togglePaymentMethods(isPickup) {
      if (!paymentSelect) return;
      
      const cashOnDeliveryOption = paymentSelect.querySelector('option[value="Cash On Delivery"]');
      const payAtStoreOption = paymentSelect.querySelector('option[value="Pay at the store"]');
      
      if (isPickup) {
        // For Pickup: Remove Cash On Delivery, Show Pay at the store
        if (cashOnDeliveryOption) {
          // If Cash On Delivery was selected, switch to Pay at the store
          if (paymentSelect.value === 'Cash On Delivery') {
            paymentSelect.value = 'Pay at the store';
          }
          cashOnDeliveryOption.remove();
        }
        
        // Show Pay at the store option if it doesn't exist
        if (!payAtStoreOption && payAtStoreOptionTemplate) {
          const newOption = payAtStoreOptionTemplate.cloneNode(true);
          // Insert after GCash option
          const gcashOption = paymentSelect.querySelector('option[value="GCash"]');
          if (gcashOption && gcashOption.nextSibling) {
            paymentSelect.insertBefore(newOption, gcashOption.nextSibling);
          } else {
            paymentSelect.appendChild(newOption);
          }
        }
      } else {
        // For Delivery: Show Cash On Delivery, Hide Pay at the store
        if (!cashOnDeliveryOption && cashOnDeliveryOptionTemplate) {
          // Restore Cash On Delivery option if it doesn't exist
          const newOption = cashOnDeliveryOptionTemplate.cloneNode(true);
          // Insert after the "Select Payment Method" option
          const selectOption = paymentSelect.querySelector('option[value=""]');
          if (selectOption && selectOption.nextSibling) {
            paymentSelect.insertBefore(newOption, selectOption.nextSibling);
          } else {
            paymentSelect.appendChild(newOption);
          }
        }
        
        // Remove Pay at the store option
        if (payAtStoreOption) {
          // If Pay at the store was selected, switch to Cash On Delivery
          if (paymentSelect.value === 'Pay at the store') {
            paymentSelect.value = 'Cash On Delivery';
          }
          payAtStoreOption.remove();
        }
      }
    }

    if (orderTypeSelect && addressGroup && addressInput) {
      orderTypeSelect.addEventListener('change', () => {
        if (orderTypeSelect.value === 'Pickup') {
          addressGroup.style.display = 'none';
          addressInput.removeAttribute('required');
          addressInput.value = '';
          
          // Update payment methods for Pickup orders
          togglePaymentMethods(true);
        } else {
          addressGroup.style.display = 'block';
          addressInput.setAttribute('required', 'required');
          
          // Update payment methods for Delivery orders
          togglePaymentMethods(false);
        }
        
        // Update order summary when order type changes
        updateOrderSummary();
      });
      
      // Initialize on page load
      if (orderTypeSelect.value === 'Pickup') {
        togglePaymentMethods(true);
      } else {
        togglePaymentMethods(false);
      }
    }

    // OTP Verification Logic
    let recaptchaVerifier = null;
    let confirmationResult = null;
    let isPhoneVerified = false;

    // Wait for Firebase to be loaded
    function waitForFirebase(callback) {
      if (window.firebaseAuth && window.RecaptchaVerifier && window.signInWithPhoneNumber) {
        callback();
      } else {
        setTimeout(() => waitForFirebase(callback), 100);
      }
    }

    // Function to clear existing reCAPTCHA verifier
    function clearRecaptcha() {
      if (recaptchaVerifier) {
        try {
          recaptchaVerifier.clear();
        } catch (e) {
          console.warn('Error clearing reCAPTCHA:', e);
        }
        recaptchaVerifier = null;
      }
      // Clear the container element
      const recaptchaContainer = document.getElementById('recaptcha-container');
      if (recaptchaContainer) {
        recaptchaContainer.innerHTML = '';
      }
    }

    // Initialize reCAPTCHA verifier
    function initializeRecaptcha() {
      // Clear any existing verifier first
      clearRecaptcha();
      
      const recaptchaContainer = document.getElementById('recaptcha-container');
      if (!recaptchaContainer) {
        throw new Error('reCAPTCHA container not found');
      }

      try {
        recaptchaVerifier = new window.RecaptchaVerifier(window.firebaseAuth, 'recaptcha-container', {
          'size': 'invisible',
          'callback': () => {
            console.log('reCAPTCHA verified');
          },
          'expired-callback': () => {
            console.log('reCAPTCHA expired');
            recaptchaVerifier = null;
          }
        });
        return true;
      } catch (error) {
        console.error('reCAPTCHA initialization error:', error);
        // If error is about already rendered, clear and try again
        if (error.message && error.message.includes('already been rendered')) {
          clearRecaptcha();
          // Wait a bit and try again
          setTimeout(() => {
            try {
              recaptchaVerifier = new window.RecaptchaVerifier(window.firebaseAuth, 'recaptcha-container', {
                'size': 'invisible',
                'callback': () => {
                  console.log('reCAPTCHA verified');
                },
                'expired-callback': () => {
                  console.log('reCAPTCHA expired');
                  recaptchaVerifier = null;
                }
              });
            } catch (retryError) {
              console.error('reCAPTCHA retry failed:', retryError);
            }
          }, 100);
          return false;
        }
        throw error;
      }
    }

    // Send OTP button handler
    document.getElementById('send-otp-btn')?.addEventListener('click', async () => {
      const phoneInput = document.getElementById('contactnumber');
      const phoneNumber = phoneInput.value.trim();
      const otpGroup = document.getElementById('otp-verification-group');
      const otpStatus = document.getElementById('otp-status');
      const sendOtpBtn = document.getElementById('send-otp-btn');

      if (!phoneNumber) {
        Swal.fire({
          icon: 'warning',
          title: 'Phone Number Required',
          text: 'Please enter your phone number first.'
        });
        return;
      }

      // Validate phone number format (should start with +)
      if (!phoneNumber.startsWith('+')) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid Format',
          text: 'Please enter phone number with country code (e.g., +639123456789)'
        });
        return;
      }

      // Wait for Firebase to be ready
      await new Promise(resolve => waitForFirebase(resolve));

      // Check if Firebase initialized successfully
      if (window.firebaseInitialized === false) {
        Swal.fire({
          icon: 'error',
          title: 'Firebase Not Initialized',
          text: window.firebaseError || 'Firebase failed to initialize. Please refresh the page.'
        });
        return;
      }

      try {
        sendOtpBtn.disabled = true;
        sendOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
        otpStatus.textContent = 'Sending OTP...';
        otpStatus.className = 'form-text text-info';

        // Always initialize/reinitialize reCAPTCHA to avoid "already rendered" errors
        // This handles both first-time use and resend scenarios
        try {
          initializeRecaptcha();
          // Wait a moment for reCAPTCHA to be ready
          await new Promise(resolve => setTimeout(resolve, 100));
        } catch (recaptchaError) {
          console.error('reCAPTCHA initialization error:', recaptchaError);
          sendOtpBtn.disabled = false;
          sendOtpBtn.innerHTML = '<i class="fas fa-sms"></i> Send OTP';
          throw new Error('Failed to initialize reCAPTCHA. Please refresh the page and try again.');
        }

        // Ensure reCAPTCHA is initialized before sending
        if (!recaptchaVerifier) {
          throw new Error('reCAPTCHA verifier not initialized');
        }

        // Send OTP
        confirmationResult = await window.signInWithPhoneNumber(window.firebaseAuth, phoneNumber, recaptchaVerifier);
        
        // Show OTP input
        otpGroup.style.display = 'block';
        otpStatus.textContent = 'OTP sent! Please check your phone for the verification code.';
        otpStatus.className = 'form-text text-success';
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="fas fa-sms"></i> Resend OTP';
        
        Swal.fire({
          icon: 'success',
          title: 'OTP Sent!',
          text: 'Please check your phone for the verification code.',
          timer: 3000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error sending OTP:', error);
        sendOtpBtn.disabled = false;
        sendOtpBtn.innerHTML = '<i class="fas fa-sms"></i> Send OTP';
        otpStatus.textContent = 'Failed to send OTP. Please try again.';
        otpStatus.className = 'form-text text-danger';
        
        // Reset reCAPTCHA on error
        clearRecaptcha();
        
        let errorMessage = 'Please try again later.';
        let helpText = '';
        
        if (error.code === 'auth/captcha-check-failed') {
          const currentHost = window.location.hostname;
          errorMessage = 'Domain not authorized in Firebase Console.';
          helpText = `
            <div style="text-align: left; margin-top: 15px;">
              <p><strong>Current hostname:</strong> <code>${currentHost}</code></p>
              <p><strong>To fix this:</strong></p>
              <ol style="margin-left: 20px; margin-top: 10px;">
                <li>Go to <a href="https://console.firebase.google.com/project/eazzymart-otp/authentication/settings" target="_blank">Firebase Console â†’ Authentication â†’ Settings</a></li>
                <li>Scroll down to <strong>"Authorized domains"</strong> section</li>
                <li>Click <strong>"Add domain"</strong></li>
                <li>Add your domain:
                  <ul style="margin-top: 5px;">
                    <li>For localhost: <code>localhost</code> (usually already added)</li>
                    <li>For 127.0.0.1: <code>127.0.0.1</code></li>
                    <li>For your domain: <code>${currentHost}</code></li>
                  </ul>
                </li>
                <li>Click <strong>"Add"</strong> and wait a few seconds</li>
                <li>Refresh this page and try again</li>
              </ol>
              <p style="margin-top: 10px; color: #856404; background: #fff3cd; padding: 10px; border-radius: 4px;">
                <strong>Note:</strong> If testing locally, make sure <code>localhost</code> or <code>127.0.0.1</code> is in the authorized domains list.
              </p>
            </div>
          `;
        } else if (error.code === 'auth/billing-not-enabled') {
          errorMessage = 'Billing must be enabled for Phone Authentication.';
          helpText = `
            <div style="text-align: left; margin-top: 15px;">
              <p><strong>To enable billing:</strong></p>
              <ol style="margin-left: 20px; margin-top: 10px;">
                <li>Go to <a href="https://console.firebase.google.com/project/eazzymart-otp/settings/usage" target="_blank">Firebase Console â†’ Project Settings â†’ Usage and billing</a></li>
                <li>Click "Modify plan" or "Upgrade"</li>
                <li>Select the <strong>Blaze (pay-as-you-go)</strong> plan</li>
                <li>Add a billing account (credit card required)</li>
                <li>Note: Firebase offers <strong>10 free SMS per day</strong> for testing</li>
              </ol>
              <p style="margin-top: 10px;"><small>Phone Authentication requires the Blaze plan, but you won't be charged until you exceed the free tier limits.</small></p>
            </div>
          `;
        } else if (error.code === 'auth/configuration-not-found') {
          errorMessage = 'Phone Authentication is not enabled in Firebase Console.';
          helpText = '<p><small>Go to Firebase Console â†’ Authentication â†’ Sign-in method â†’ Phone â†’ Enable</small></p>';
        } else if (error.code === 'auth/invalid-phone-number') {
          errorMessage = 'Invalid phone number format. Please use format: +[country code][number] (e.g., +639123456789)';
        } else if (error.code === 'auth/too-many-requests') {
          errorMessage = 'Too many requests. Please try again later.';
        } else if (error.message) {
          errorMessage = error.message;
        }
        
        Swal.fire({
          icon: 'error',
          title: 'Failed to Send OTP',
          html: `<p>${errorMessage}</p>${helpText}`,
          confirmButtonText: 'OK',
          width: '600px'
        });
      }
    });

    // Verify OTP button handler
    document.getElementById('verify-otp-btn')?.addEventListener('click', async () => {
      const otpCode = document.getElementById('otp-code').value.trim();
      const otpStatus = document.getElementById('otp-status');
      const verifyOtpBtn = document.getElementById('verify-otp-btn');

      if (!otpCode || otpCode.length !== 6) {
        Swal.fire({
          icon: 'warning',
          title: 'Invalid OTP',
          text: 'Please enter a valid 6-digit OTP code.'
        });
        return;
      }

      if (!confirmationResult) {
        Swal.fire({
          icon: 'warning',
          title: 'No OTP Sent',
          text: 'Please send OTP first.'
        });
        return;
      }

      try {
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';
        otpStatus.textContent = 'Verifying OTP...';
        otpStatus.className = 'form-text text-info';

        // Verify OTP
        const result = await confirmationResult.confirm(otpCode);
        
        // Phone verified successfully
        isPhoneVerified = true;
        otpStatus.textContent = 'Phone number verified successfully!';
        otpStatus.className = 'form-text text-success';
        verifyOtpBtn.disabled = true;
        verifyOtpBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verified';
        document.getElementById('otp-code').disabled = true;
        document.getElementById('contactnumber').disabled = true;
        document.getElementById('send-otp-btn').disabled = true;

        // Store verification status
        window.phoneVerified = true;

        Swal.fire({
          icon: 'success',
          title: 'Verified!',
          text: 'Your phone number has been verified successfully.',
          timer: 2000,
          showConfirmButton: false
        });
      } catch (error) {
        console.error('Error verifying OTP:', error);
        verifyOtpBtn.disabled = false;
        verifyOtpBtn.innerHTML = '<i class="fas fa-check"></i> Verify';
        otpStatus.textContent = 'Invalid OTP. Please try again.';
        otpStatus.className = 'form-text text-danger';
        
        Swal.fire({
          icon: 'error',
          title: 'Verification Failed',
          text: error.message || 'Invalid OTP code. Please try again.'
        });
      }
    });

    // Store verification status globally
    window.isPhoneVerified = () => isPhoneVerified;
  </script>
</body>
</html>

